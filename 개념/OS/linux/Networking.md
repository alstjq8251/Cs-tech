## Networking

![Image](https://github.com/user-attachments/assets/1b80c146-5c47-43e1-97e5-dad636e1b9af)

- 네트워크엔 변화하는 분야와 계층이 많아 문제가 발생할 시 하드웨어, 소프트웨어 문제를 판별하기가 쉽지 않다.
- 리눅스 네트워킹은 추상화를 다루는데 이 모든 근간은 유선과 무선을 통해 이동하는 비트(bit)라는 사실을 잊어선 안된다.
- 위 사진은 네트워킹이 동작하는 방식이다.
  - 1. 이더넷이나 무선 카드 같은 일종의 네트워킹 하드웨어가 있다.
    2. TCP/IP 스택 가튼 커널 수준의 다양한 구성 요소
    3. 사용자 공간에서 네트워킹을 구성, 쿼리, 사용하기 위한 다양한 도구가 있다. 

### TCP/IP

- TCP/IP 스택은 IETF 사양에 의해 정의된 여러 프로토콜과 도구로 이뤄진 계층 네트워크 모델이다.
- 각 계층은 자신과 인접한 계층만 인식하고 통신할 수 있으며 데이터는 패킷으로 캡슐화되고 계층별 기능과 관련된 정보를 포함한 헤더로 데이터를 래핑한다.
- 앱은 최상위 계층과만 직접 상호작용하고 송신, 수신 시 각 계층별 헤더를 추가해 하위 계층에 전달하거나 페이로드를 상위 계층에 전달한다.

`링크 계층`
- 스택의 가장 하부 계층으로 하드웨어(이더넷,와이파이)와 커널 드라이버를 다루며 물리적 디바이스 간 패킷이 어떻게 전송되는지에 중점을 둔다.

`인터넷 계층`
- 인터넷 프로토콜(IP)을 이용하며, 라우팅에 초점을 맞춘 계층이다. 즉 네트워크를 통한 기기간의 패킷 전송을 지원

`전송 계층`
- 세션 기반의 안정적 통신을 위한 TCP와  비 연결형 통신을 위한 UDP를 사용해 호스트 사이 종단 간 통신을 제어하는 계층이다.
- 패킷이 전송되는 방식을 다루며 포트를 통한 시스템 개별 서비스 지정과 데이터 무결성이 포함된다. 
- 리눅스는 소켓을 통신의 엔드포인트로 지원한다.

`애플리케이션 계층`
- 웹, SSH, 메일과 같은 사용자 대면 도구와 앱을 다루는 계층이다.

> 계층화란 계층의 헤더와 페이로드가 다음 계층의 페이로드를 구성하는 것을 의미한다.

### 링크 계층

**용어 정리**

`이더넷(eternet)`
- 유선을 이용해 기기를 연결하는 네트워킹 기술로 근거리 통신망(LAN)dptj wkwn tkdyd
`MAC(Media Access Control) 주소`
- MAC은 각 하드웨어마다 고유한 48비트 식별자로 각 기기(nic)를 식별하는데 사용된다.
- MAC은 일반적으로 첫 24비트를 조직 고유 식별자(OUI)로 사용해 제조업체 정보를 인코딩한다.
`인터페이스`
- 네트워크 연결. 물리적 인터페이스 일 수도, 루프백 인터페이스 lo 같은 가상(소프트웨어) 인터페이스 일 수도 있다.

#### 네트워크 인터페이스 컨트롤러(NIC)

- 하드웨어 장비 중 필수 요소 중 하나는 네트워크 인터페이스 컨트롤러(nic)로 NIC는 유선 표준이나 IEEE 802.11의 많은 무선 표준 중 하날 통해 네트워크에 물리적 연결을 제공한다.
- 전송하려는 바이트의 디지털 표현을 전기 혹은 전자기 신호로 바꾼다.
- NIC는 수신하는 모든 물리적 신호를 소프트웨어가 처리할 수 있는 비트와 바이트로 변환한다.

#### 주소 결정 프로토콜(ARP)

- ARP는 MAC 주소를 IP 주소에 매핑, 어떤 의미에선 링크 계층을 그 위 계층인 인터넷 계층과 연결하는 것이다.

### 인터넷 계층

- 네트워크의 한 시스템에서 다른 시스템으로 패킷을 라우팅하는 것과 관련이 있다.
- 최선의 전달(성능에 대한 보장 없음)을 제공하고 모든 패킷을 독립적으로 취급해 상위 계층(일반적으로 전송 계층)은 패킷의 순서, 재시도, 배달 보장을 포함한 신뢰성 문제를 처리한다.

#### IPv4

- IPv4는 TCP/IP 통신에서 엔드포인트 역할을 하는 호스트나 프로세스를 고유하게 식별하는 32비트 숫자를 정의한다.
- 32비트를 마침표로 구분된 4개의 8비트 조각 즉 **옥텟(octet)**으로 구분하는 게 IPv4를 작성하는 한 가지 방법이며 범위는 0~255다.

- RFC 791을 비롯 IETF 사양에 정의된 것처럼 IP헤더엔 많은 필드가 있지만 가장 중요한 필드는 하단과 같다.
    - `송신지 주소(source address(32비트))`
    - `수신지 주소(destination address(32비트))`
    - `프로토콜(8비트)`
    - `TTL(생존 시간 time to live 8비트)`
      - 패킷이 존재할 수 있는 최대 시간
    - `서비스 유형 ToS, type of service(8비트)`
      - 서비스 품질QoS, quality of service 용도로 사용

- IP 주소 범위는 네트워크에 핼당되며 해당 네트워크 내에서 개별 호스트에 할당되고 오늘날은 CIDR(Classless Inter-Domain Routing)이 IP주소와 관련된 방법이다.
  - CIDR 형식은 두 부분으로 나뉜다.
  - 1. 첫 번째 부분은 네트워크 주소를 의미. 이는 일반 IP 주소(10.0.0.0)처럼 보임
    2. 두 번째 부분은 얼마나 많은 비트(그리고 IP 주소)가 주소 범위에 속하는 지를 정의(ex: /24)한다.

- 다음은 알아둬야 하는 예약된 IPv4 주소다.
  - `127.0.0.1`
    - 이 서브넷은 로컬 주소용으로 예약되어 있으며 가장 중요한 것은 루프백 주소인 **127.0.0.1**이다.
  - `169.254.0.0/16 (169.254.0.0~169.254.255.255)`
    - 링크 로컬 주소로 전송된 패킷이 네트워크의 다른 부분으로 전달되지 않아야 함을 의미한다.
    - aws 같은 일부 클라우드 공급자는 이 주소를 특수 서비스(메타데이터)에 사용한다.
  - `224.0.0.0/24 (224.0.0.0~224.0.0.255)`
    - 이 범위는 멀티캐스트용으로 예약되어 있다.

- RFC 1918엔 사설 IP 범위가 정의돼 있으며 해당 IP주소를 공용 인터넷에서 라우팅할 수 없음을 의미한다.
  - 10.0.0.0 ~ 10.255.255.255 (10/8)
  - 162.16.0.0 ~ 172.31.255.255 (162.16/12)
  - 192.168.0.0 ~ 192.168.255.255 (192.168.0.0/16)

- 0.0.0.0 의 IP주소는 라우팅 불가능한 주소이며 상황마다 용례가 다르지만 서버 관점에서 제일 중요한건 시스템에 있는 모든 IPv4 주소를 의미한다는 점이다.
- 이는 알려진 IP로 바뀔 때까지 송신지 선택을 위해 "모든 사용 가능한 IP주소에서 수신 대기하라"는 의미이다.

> IPv4 주소 공간은 고갈되었으며 인터넷 설계자가 생각했던 것보다 엔드포인트가 많다는 점을 감안할 때 IPv6라는 대안은 존재한다.
> 아직 많은 시스템이 전환되지 못했는데 부분적으론 인프라 스트럭처 때문이지만 IPv6를 지원하는 도구가 부족한 때문이기도 하다.

#### IPv6

- 인터넷 프로토콜 버전 6(IPv6)은 TCP/IP 통신에서 ㅅ엔드포인트 식별용으로 쓰이는 128비트 숫자다.
- 개별 기기를 10(38승)개까지 할당할 수 있으며 IPv4와 다르게 IPv6는 각각 16 비트로 구성된 8개 그룹을 콜론(:)으로 구분하는 16진수 표현식을 사용한다.
- 이런 IPv6주소를 짧게 줄이기 위한 몇가지 규칙이 있는데 선행되는 0을 제거하거나 연속되는 0의 섹션을 2개의 콜론(::)으로 대체하는 등이다.
  - ex:) IPv6 루프백 주소는 ::1(IPv4는 127.0.0.1)로 줄여서 작성할 수 있다.

**IPv4와 IPV6은 호환되지 않는다는 점에 유의해야 한다.**

#### 인터넷 제어 메시지 프로토콜

- RFC 792엔 에러 메세지와 가용성 같은 운영 정보를 보내는 저수준 구성요소에 사용되는 ICMP가 정의돼 있다.

#### 라우팅

- 리눅스에서 네트워크 스택의 일부는 라우팅과 관련이 있는데 즉 패킷을 보낼 위치를 패킷별로 결정한다.
- 라우팅 테이블을 조작하는데 널리 사용되는 도구인 `iptables`는 패킷을 가로채고 조작하기 위해 `netfilter`를 사용한다.

<details>
<summary><strong>라우팅 정보 쿼리 예시</strong></summary>
<div>

```shell

# 옛날 방법

$ sudo route -n # 숫자로 된 IP 주소를 보려면 -n과 함꼐 route 명령어 사용
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         192.168.178.1   0.0.0.0         UG    0      0        0 eth0
169.254.0.0     0.0.0.0         255.255.0.0     U     1002   0        0 eth0
172.17.0.0      0.0.0.0         255.255.0.0     U     0      0        0 docker0

# 현대적 방법

$ sudo ip route
default via 192.168.178.1 dev eth0
169.254.0.0/16 dev eth0 scope link metric 1002

```

- route 명령간 표로 출력된 필드의 의미
  - `Destinaion`
    - 수신지의 IP 주소 0.0.0.0은 지정되지 않았거나 알 수 없음을 의미하며 잠재적으로 게이트웨이로 보낼 수 있다.
  - `Gateway`
    - 동일한 네트워크에 있지 않은 패킷의 경우 게이트웨이 주소
  - `Genmask`
    - 사용된 서브넷 마스크
  - `Flags`
    - UG는 네트워크가 동작 중이며 이것이 게이트웨이임을 의미한다.
  - `Iface`
    - 패킷이 사용할 네트워크 인터페이스
    - 

</div>
</details>

#### 경계 게이트웨이 프로토콜(BGP)

- 네트워크는 **자율 시스템(autonomous system AS)**라고 부르는데 IP 라우팅이 동작하려면 이런 자율 
 
  시스템들이 해당 라우팅 데이터와 도달 가능성 데이터를 공유하고 인터넷을 통해 패킷을 전달하는 경로를 알려야 한다.

### 전송 계층

- 이 계층은 전부 엔드포인트 즉 종단 간 통신 특성에 관한 것이다.
- 연결 지향형 프로토콜(TCP)와 비 연결 프로토콜(UDP)이 있는데 이들의 신뢰성, QoS, 순차 배송은 중요한 부분이다.

#### 포트

- 어떤 프로토콜이 사용되는 그 각각은 포트가 필요한데 포트란 IP 주소에서 사용 가능한 서비스를 식별하는 고유 16비트 숫자다.
- 포트는 하단과 같이 구분 가능하다.
  - 잘 알려진 포트(0~1023)
    - SSH 서버나 웹 서버 같은 데몬용이며 이 중 하나를 바인딩하려면 높은 권한이 필요하다.
  - 등록된 포트(1024~49151)
    - 인터넷 할당 번호 관리기관(IANA)이 공개적으로 문서화된 프로세스를 통해 관리한다.
  - 한시적 포트(49152~65535)
    - 등록할 수 없는 포튼데 한시적 포트를 자동으로 할당하는데 사용되거나 개인 서비스에도 사용이 가능하다.

> /etc/services에서 포트와 매핑을 볼 수 있다.

#### 전송 제어 프로토콜(TCP)

- TCP는 HTTP와 SSH를 포함한 여러 고수준 프로토콜에서 사용되는 연결 지향 전송 계층 프로토콜이다.
- 패킷을 순서대로 전달하는 것을 보장하고 오류 발생 시 재전송을 지원하는 세션 기반 프로토콜이다.